{% extends "conformity/main.html" %}
{% load django_bootstrap5 %}

{% block header %}
<h1 class="h1 bi bi-pencil-square" xmlns="http://www.w3.org/1999/html"> Edit of an action record</h1>
{% endblock %}

{% block content %}
    <form class="form" method="post" action="" style="table-radius:1em">
        {% csrf_token %}
        <div class="row justify-content-center">
            <div class="col col-6">
                {% bootstrap_field form.title layout='floating' %}
                {% bootstrap_field form.owner layout='floating' %}
                {% bootstrap_field form.status layout='floating' %}
                {% bootstrap_field form.status_comment layout='floating' %}
                <p class="text-center fw-lighter mx-3">Created on {{ form.create_date.value }}, laste update {{ form.update_date.value }}.</p>
                <div class="accordion" id="accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingAnalyse">
                            <button class="accordion-button text-bg-info collapsed" type="button" id="buttonAnalyse" data-bs-toggle="collapse"
                                    data-bs-target="#collapseAnalyse" aria-expanded="false" aria-controls="collapseAnalyse">
                                Analyse
                            </button>
                        </h2>
                        <div id="collapseAnalyse" class="accordion-collapse collapse" aria-labelledby="headingAnalyse"
                             data-bs-parent="#accordion">
                            <div class="accordion-body text-bg-light">
                                {% bootstrap_field form.description layout='floating' %}
                                {% bootstrap_field form.organization layout='floating' %}
                                {% bootstrap_field form.associated_conformity layout='floating' %}
                                {% bootstrap_field form.associated_findings layout='floating' %}
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingPlan">
                            <button class="accordion-button text-bg-primary collapsed" type="button" id="buttonPlan" data-bs-toggle="collapse"
                                    data-bs-target="#collapsePlan" aria-expanded="false" aria-controls="collapsePlan">
                                Plan
                            </button>
                        </h2>
                        <div id="collapsePlan" class="accordion-collapse collapse" aria-labelledby="headingPlan"
                             data-bs-parent="#accordion">
                            <div class="accordion-body text-bg-light">
                                {% bootstrap_field form.plan_start_date layout='floating' %}
                                {% bootstrap_field form.plan_end_date layout='floating' %}
                                {% bootstrap_field form.plan_comment layout='floating' %}
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingImplement">
                            <button class="accordion-button text-bg-warning collapsed" type="button" id="buttonImplement" data-bs-toggle="collapse"
                                    data-bs-target="#collapseImplement" aria-expanded="false" aria-controls="collapseImplement">
                                Implement
                            </button>
                        </h2>
                        <div id="collapseImplement" class="accordion-collapse collapse" aria-labelledby="headingImplement"
                             data-bs-parent="#accordion">
                            <div class="accordion-body text-bg-light">
                                {% bootstrap_field form.implement_start_date layout='floating' %}
                                {% bootstrap_field form.implement_end_date layout='floating' %}
                                {% bootstrap_field form.implement_status layout='floating' %}
                                {% bootstrap_field form.implement_comment layout='floating' %}
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingControl">
                            <button class="accordion-button text-bg-success collapsed" type="button" id="buttonControl" data-bs-toggle="collapse"
                                    data-bs-target="#collapseControl" aria-expanded="false" aria-controls="collapseControl">
                                Control
                            </button>
                        </h2>
                        <div id="collapseControl" class="accordion-collapse collapse" aria-labelledby="headingControl"
                             data-bs-parent="#accordion">
                            <div class="accordion-body text-bg-light">
                                {% bootstrap_field form.control_date layout='floating' %}
                                {% bootstrap_field form.control_comment layout='floating' %}
                                {% bootstrap_field form.control_user layout='floating' %}
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                {% bootstrap_button button_type="submit" content="Save" %}
            </div>
        </div>
        <script>
            // Dirty fix for Date form
            // https://github.com/zostera/django-bootstrap5/issues/445
            // TODO: contribute upstream to django-bootstrap
            document.getElementById('id_control_date').type = 'Date'
            document.getElementById('id_implement_start_date').type = 'Date'
            document.getElementById('id_implement_end_date').type = 'Date'
            document.getElementById('id_plan_start_date').type = 'Date'
            document.getElementById('id_plan_end_date').type = 'Date'
        </script>
        <script>
            // Open the good accordion at page load
            if (document.getElementById('id_status').value == '1') {
                document.getElementById('id_status_comment').parentNode.classList.add("d-none");
                document.getElementById('buttonAnalyse').classList.remove("collapsed");
                document.getElementById('collapseAnalyse').classList.add("show");
            } else if (document.getElementById('id_status').value == '2') {
                document.getElementById('id_status_comment').parentNode.classList.add("d-none");
                document.getElementById('buttonPlan').classList.remove("collapsed");
                document.getElementById('collapsePlan').classList.add("show");
            } else if (document.getElementById('id_status').value == '3') {
                document.getElementById('id_status_comment').parentNode.classList.add("d-none");
                document.getElementById('buttonImplement').classList.remove("collapsed");
                document.getElementById('collapseImplement').classList.add("show");
            } else if (document.getElementById('id_status').value == '4') {
                document.getElementById('id_status_comment').parentNode.classList.add("d-none");
                document.getElementById('buttonControl').classList.remove("collapsed");
                document.getElementById('collapseControl').classList.add("show");
            }

            // Display the field id_status_comment for MISC status
            document.getElementById('id_status').onchange = function(){
                if (document.getElementById('id_status').value > '5') {
                    document.getElementById('id_status_comment').parentNode.classList.remove("d-none");
                    document.getElementById('id_status_comment').required = true;
                } else {
                    document.getElementById('id_status_comment').parentNode.classList.add("d-none");
                    document.getElementById('id_status_comment').required = false;
                }
            };
        </script>
    </form>
{% endblock %}
